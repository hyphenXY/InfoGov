import json
import requests


def get_data_from_api(api_url):
    response = requests.get(api_url)
    response.raise_for_status()  # Raise an exception for bad status codes
    return response.json()


def extract_data(data, key):
    try:
        return data[key]
    except KeyError:
        return None


i = 1
while True:
    api_url = f"https://loadqa.ndapapi.com/v1/openapi?API_Key=gAAAAABnRB1WZUHm_tNY2BXsc_g6zn__m_IZVaZ4W4y2oqH5uixTh32qVBDiBFI2nsvMd9NYcbyNek6O3fk9N8UCXQY8Ad7V-l9wwu9UelQPxqz7JM-oFxV5e_vnRFzsUByTdXCZ1NI2hzdCghlP1rBUV-YBg6T1ozzU3q8fKDAHi7KXr1hwvNhmT2x2kq2KXS6DAn6mPlFf&ind=I7135_9,I7135_10,I7135_11,I7135_12,I7135_13,I7135_14,I7135_15,I7135_16,I7135_17,I7135_18,I7135_24,I7135_51,I7135_52,I7135_55,I7135_56,I7135_57,I7135_58,I7135_60,I7135_62,I7135_64,I7135_66,I7135_68,I7135_70,I7135_72,I7135_73,I7135_74,I7135_76,I7135_77,I7135_78,I7135_79,I7135_82,I7135_85,I7135_88,I7135_91,I7135_94,I7135_97,I7135_98,I7135_99,I7135_100,I7135_101,I7135_102,I7135_103,I7135_104,I7135_105,I7135_106,I7135_107,I7135_108,I7135_109,I7135_110,I7135_111,I7135_112,I7135_113,I7135_114,I7135_115,I7135_116,I7135_117,I7135_118,I7135_119,I7135_120,I7135_121,I7135_122,I7135_123,I7135_124,I7135_125,I7135_126,I7135_127,I7135_128,I7135_129,I7135_130,I7135_131,I7135_132,I7135_133,I7135_134,I7135_135,I7135_136,I7135_137,I7135_138,I7135_139,I7135_140,I7135_141,I7135_142,I7135_143,I7135_144,I7135_145,I7135_146,I7135_147,I7135_148,I7135_149,I7135_150,I7135_151,I7135_152,I7135_153,I7135_154,I7135_155,I7135_156,I7135_157,I7135_158,I7135_159,I7135_160,I7135_161,I7135_162,I7135_163,I7135_164,I7135_165,I7135_166,I7135_167,I7135_168,I7135_169,I7135_170,I7135_171,I7135_172,I7135_173,I7135_174,I7135_175,I7135_176,I7135_177,I7135_178,I7135_179,I7135_180,I7135_181,I7135_182,I7135_183,I7135_185,I7135_187,I7135_190,I7135_192,I7135_194,I7135_197,I7135_199,I7135_201,I7135_204,I7135_206,I7135_208,I7135_211,I7135_213,I7135_215,I7135_218,I7135_220,I7135_222,I7135_225,I7135_227,I7135_229,I7135_232,I7135_234,I7135_236,I7135_239,I7135_241,I7135_243,I7135_246,I7135_248,I7135_250,I7135_253,I7135_255,I7135_257,I7135_260,I7135_262,I7135_264,I7135_267,I7135_269,I7135_271,I7135_274,I7135_276,I7135_278,I7135_281,I7135_283,I7135_285,I7135_288,I7135_290,I7135_292,I7135_295,I7135_297,I7135_299,I7135_302,I7135_304,I7135_306,I7135_309,I7135_311,I7135_313,I7135_316,I7135_318,I7135_320,I7135_323,I7135_325,I7135_327,I7135_330,I7135_332,I7135_334,I7135_337,I7135_339,I7135_341,I7135_344,I7135_346,I7135_348,I7135_351,I7135_353,I7135_355,I7135_358,I7135_360,I7135_362,I7135_365,I7135_367,I7135_369,I7135_372,I7135_374,I7135_376,I7135_379,I7135_381,I7135_383,I7135_386,I7135_388,I7135_390,I7135_393,I7135_395,I7135_397,I7135_400,I7135_402,I7135_404,I7135_407,I7135_409,I7135_411,I7135_414,I7135_416,I7135_418,I7135_421,I7135_425,I7135_426,I7135_427,I7135_428,I7135_429&dim=Country,StateName,StateCode,DistrictName,DistrictCode,SubDistrictName,SubDistrictCode,ULB_RLB_VillageName,ULB_RLB_VillageCode,Year,D7135_20,D7135_21,D7135_75,D7135_80,D7135_81,D7135_83,D7135_84,D7135_86,D7135_87,D7135_89,D7135_90,D7135_92,D7135_93,D7135_95,D7135_184,D7135_186,D7135_188,D7135_191,D7135_193,D7135_195,D7135_198,D7135_200,D7135_202,D7135_205,D7135_207,D7135_209,D7135_212,D7135_214,D7135_216,D7135_219,D7135_221,D7135_223,D7135_226,D7135_228,D7135_230,D7135_233,D7135_235,D7135_237,D7135_240,D7135_242,D7135_244,D7135_247,D7135_249,D7135_251,D7135_254,D7135_256,D7135_258,D7135_261,D7135_263,D7135_265,D7135_268,D7135_270,D7135_272,D7135_275,D7135_277,D7135_279,D7135_282,D7135_284,D7135_286,D7135_289,D7135_291,D7135_293,D7135_296,D7135_298,D7135_300,D7135_303,D7135_305,D7135_307,D7135_310,D7135_312,D7135_314,D7135_317,D7135_319,D7135_321,D7135_324,D7135_326,D7135_328,D7135_331,D7135_333,D7135_335,D7135_338,D7135_340,D7135_342,D7135_345,D7135_347,D7135_349,D7135_352,D7135_354,D7135_356,D7135_359,D7135_361,D7135_363,D7135_366,D7135_368,D7135_370,D7135_373,D7135_375,D7135_377,D7135_380,D7135_382,D7135_384,D7135_387,D7135_389,D7135_391,D7135_394,D7135_396,D7135_398,D7135_401,D7135_403,D7135_405,D7135_408,D7135_410,D7135_412,D7135_415,D7135_417,D7135_419,D7135_59,D7135_61,D7135_63,D7135_65,D7135_67,D7135_69,D7135_71,D7135_96,D7135_189,D7135_196,D7135_203,D7135_210,D7135_217,D7135_224,D7135_231,D7135_238,D7135_245,D7135_252,D7135_259,D7135_266,D7135_273,D7135_280,D7135_287,D7135_294,D7135_301,D7135_308,D7135_315,D7135_322,D7135_329,D7135_336,D7135_343,D7135_350,D7135_357,D7135_364,D7135_371,D7135_378,D7135_385,D7135_392,D7135_399,D7135_406,D7135_413,D7135_420,D7135_422,D7135_423,D7135_424&pageno={i}"
    extracted_data = get_data_from_api(api_url)
    if i==81:
        break
    # print(extracted_data["IsError"])
    print(i)
    headers = get_data_from_api(api_url)["Headers"]["Items"]
    id_to_displayname = {header["ID"]: header["DisplayName"] for header in headers}
    modified_data = []
    data = extracted_data["Data"]
    for record in data:
        modified_record = {
            id_to_displayname.get(key, key): value for key, value in record.items()
        }
        modified_data.append(modified_record)
    # print(extracted_data['Headers']['Items'][1])
    import pandas as pd

    # Function to flatten nested dictionary
    def process_data(data):
        records = []
        for record in data:
            flattened_record = {}
            for key, value in record.items():
                if isinstance(value, dict):
                    for sub_key, sub_value in value.items():
                        flattened_record[f"{key}_{sub_key}"] = sub_value
                else:
                    flattened_record[key] = value
            records.append(flattened_record)
        return records

    # Example data: List of similar dictionaries
    data_list = modified_data
    # Flatten the data
    flattened_data = process_data(data_list)

    # Convert to DataFrame
    df = pd.DataFrame(flattened_data)

    # Display the DataFrame
    print(df.columns)

    # Optionally, save to a CSV file
    # df.to_csv("education.csv", index=False)
    # append the content to "education.csv"
    df.to_csv("health.csv", mode="a", header=True, index=False)
    i += 1
